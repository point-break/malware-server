import express from 'express'
import bodyParser from 'body-parser'
import cookieParser from 'cookie-parser'
import cors from 'cors'

import io from 'lib/socketio'
import checkCookie from 'lib/check-cookie'
import {notFound, errorHandler} from 'lib/errors'

import requireAuth from 'policy/require-auth'

import auth from 'auth'
import api from 'api'

const app = express()

io.attach(app.listen(process.env.BACKEND_PORT))

app.use(cors({
  origin: process.env.FRONTEND_HOST,
  credentials: true
}))

app.use(bodyParser.json())
app.use(bodyParser.urlencoded({
  extended: true
}))
app.use(cookieParser())

app.use(checkCookie)

app.use('/auth', auth)

app.use(requireAuth)

app.use('/api', api)

app.use(notFound)
app.use(errorHandler)

export default app
