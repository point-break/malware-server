import {Location} from 'model'

import thinky from 'lib/thinky' 

const {r} = thinky

export default (req, res, next) => {
  const {lat, lng} = req.query
  const location = r.point(parseFloat(lng), parseFloat(lat))
  const searchQuery = {
    index: 'location',
    maxResults: 10
  }
  console.log(location)
  Location
    .getNearest(location, searchQuery)
    .getField('doc')
    .run()
    .then(results => {
      const nearby = results
        .map(({doc, dist}) => ({
          ...doc,
          dist
        }))
      res
        .status(200)
        .jsonp(nearby)
    })
    .catch(error => {
      error.status = 500
      next(error)
    })
}
